---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/Hero.astro';
import Card from '@/components/Card.astro';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('portfolio');
const sortedProjects = allProjects.sort((a, b) => a.data.order - b.data.order);

const allTechnologies = [...new Set(allProjects.flatMap((p) => p.data.technologies))];
---

<BaseLayout title="Portfolio | Projects" description="Explore my web development projects">
  <Hero
    title="Portfolio"
    subtitle="My Projects"
    description="A collection of projects that demonstrate my skills in web development, design, and problem-solving."
  />

  <section class="py-16">
    <div class="container">
      <div class="flex items-center gap-4 mb-12 flex-wrap">
        <span class="font-medium text-[var(--text-secondary)]">Filter by technology:</span>
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn active" data-tech="all">All</button>
          {allTechnologies.map((tech) => (
            <button class="filter-btn" data-tech={tech}>{tech}</button>
          ))}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="projects-grid">
        {sortedProjects.map((project) => (
          <div 
            class="project-item transition-opacity duration-300"
            data-technologies={project.data.technologies.join(',')}
          >
            <Card
              title={project.data.title}
              description={project.data.description}
              image={project.data.image}
              technologies={project.data.technologies}
              github={project.data.github}
              demo={project.data.demo}
              type="portfolio"
            />
          </div>
        ))}
      </div>

      <div id="no-results" class="hidden text-center py-12 text-[var(--text-secondary)]">
        <p>No projects found with the selected technology.</p>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .project-item.hidden {
    display: none;
  }
</style>

<script>
  const techBtns = document.querySelectorAll('.filter-btn');
  const projectItems = document.querySelectorAll('.project-item');
  const noResults = document.getElementById('no-results');

  techBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      techBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const selectedTech = btn.getAttribute('data-tech');
      let visibleCount = 0;

      projectItems.forEach((item) => {
        const technologies = item.getAttribute('data-technologies')?.split(',') || [];

        if (selectedTech === 'all' || technologies.includes(selectedTech || '')) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
    });
  });
</script>
